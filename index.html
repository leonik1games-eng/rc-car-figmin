<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SS Play RC - Local Physics</title>
    <meta name="figmin">
    <style>
        body { background: transparent; font-family: sans-serif; text-align: center; margin: 0; pointer-events: none; }
        .hud { 
            position: fixed; top: 20px; left: 20px; 
            background: rgba(15, 23, 42, 0.9); color: #00ff00; 
            padding: 15px; border-radius: 12px; border: 1px solid #3b82f6; 
            max-width: 300px; text-align: left; pointer-events: auto; 
        }
    </style>
</head>
<body>

    <div class="hud">
        <h1>SS PLAY RC (FÍSICA LOCAL)</h1>
        <div id="status">Conecte o Raio...</div>
        <div style="font-size:11px; color:#9ca3af; margin-top:5px;">
            A força agora segue o <b>nariz</b> do carro.
        </div>
    </div>

    <script>
        // Se o carro andar "de lado", mude para true
        const USAR_EIXO_X = true; 
        
        const FORCA_MOTOR = 600.0; 
        const VEL_CURVA = 5.0;

        var car = null;

        // MATEMÁTICA DO AVIÃO (Conversão de Local para Global)
        function getForwardVector(q) {
            // Se USAR_EIXO_X for false, extraímos o eixo Z (frente padrão)
            // Se for true, extraímos o eixo X (frente lateral)
            if (!USAR_EIXO_X) {
                return {
                    x: 2 * (q.x * q.z + q.w * q.y),
                    y: 2 * (q.y * q.z - q.w * q.x),
                    z: 1 - 2 * (q.x * q.x + q.y * q.y)
                };
            } else {
                return {
                    x: 1 - 2 * (q.y * q.y + q.z * q.z),
                    y: 2 * (q.x * q.y + q.w * q.z),
                    z: 2 * (q.x * q.z - q.w * q.y)
                };
            }
        }

        document.addEventListener("FigminReady", function() {
            car = figmin.findObjectByName("meu_carro");
            if (car) { setupCar(); }
        });

        function setupCar() {
            car.addComponent(figmin.ComponentType.PHYSICS, {
                mass: 2.0, drag: 1.5, angularDrag: 4.0,
                gravityStrength: 3.0, kinematic: false 
            });

            figmin.enableInputConnect("Pilotar", [
                figmin.InputCode.SELECT_RIGHT,
                figmin.InputCode.AXIS_Y_RIGHT,
                figmin.InputCode.AXIS_X_RIGHT,
                figmin.InputCode.THUMB_RIGHT
            ], (c) => { 
                document.getElementById("status").innerText = c ? "CONECTADO!" : "Aguardando Raio...";
            }, car);

            figmin.setUpdateFunction(update);
        }

        function update(dt) {
            if (!car || !car.physics) return;

            var throttle = figmin.getInput(figmin.InputCode.SELECT_RIGHT);
            var steer = -figmin.getInput(figmin.InputCode.AXIS_X_RIGHT);
            var stickY = figmin.getInput(figmin.InputCode.AXIS_Y_RIGHT);
            var resetBtn = figmin.getInput(figmin.InputCode.THUMB_RIGHT);

            // Determina se é frente ou ré
            var direction = 1;
            if (stickY < -0.2) {
                throttle = Math.abs(stickY);
                direction = -1;
            }

            // PEGA A FRENTE DO CARRO BASEADA NA ROTAÇÃO DELE
            var forward = getForwardVector(car.transform.rotationq);

            // Aplica a força na direção que o carro está olhando
            if (throttle > 0.05) {
                var forceMag = throttle * FORCA_MOTOR * direction * dt * 60;
                car.physics.applyForce({
                    x: forward.x * forceMag,
                    y: forward.y * forceMag,
                    z: forward.z * forceMag
                });
            }

            // Giro Local (Sempre em torno do próprio eixo Y do carro)
            if (Math.abs(steer) > 0.1) {
                car.physics.setAngularVelocity({
                    x: 0, 
                    y: steer * VEL_CURVA, 
                    z: 0
                });
            }

            // Reset
            if (resetBtn) {
                car.physics.setLinearVelocity({x:0, y:0, z:0});
                var cam = figmin.getCamera();
                car.transform.position = {
                    x: cam.transform.position.x + cam.transform.forward.x * 2,
                    y: cam.transform.position.y,
                    z: cam.transform.position.z + cam.transform.forward.z * 2
                };
            }
        }
    </script>
</body>
</html>
