<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RC Car Demo</title>
  <!-- Necessário para Figmin -->
  <meta name="figmin" />

  <style>
    :root {
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --bg: #020617;
      --text-muted: #9ca3af;
      --ui-scale: 1.6;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .card {
      padding: 24px 28px;
      border-radius: 20px;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      max-width: 440px;
      width: min(90vw, 440px);
      transform: scale(var(--ui-scale));
      transform-origin: center center;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 26px;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin: 0 0 18px;
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.35;
    }

    .status {
      margin-bottom: 12px;
      font-size: 13px;
      text-align: left;
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid rgba(148, 163, 184, 0.35);
    }

    .status-line {
      margin: 2px 0;
    }

    .status-label {
      color: var(--text-muted);
    }

    .status-value {
      font-weight: 600;
    }

    .ok {
      color: #4ade80;
    }

    .warn {
      color: #facc15;
    }

    .err {
      color: #f97373;
    }

    .controls {
      padding: 14px 16px;
      border-radius: 14px;
      background: var(--accent-soft);
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
    }

    .controls-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 11px;
      margin-bottom: 6px;
      color: #bfdbfe;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      padding: 2px 0;
    }

    .control-label {
      color: #e5e7eb;
    }

    .control-key {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.6);
      color: #dbeafe;
      white-space: nowrap;
      background: rgba(15, 23, 42, 0.8);
    }

    #output {
      font-size: 13px;
      color: #e5e7eb;
      background: rgba(2, 6, 23, 0.38);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0 0;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>RC Car</h1>
    <p class="subtitle">
      Coloque um objeto 3D na cena, renomeie para <b>meu_carro</b> e use o raio
      para conectar o controle.
    </p>

    <div class="status">
      <div class="status-line">
        <span class="status-label">Objeto 3D:</span>
        <span id="carStatus" class="status-value warn">Procurando...</span>
      </div>
      <div class="status-line">
        <span class="status-label">Controle:</span>
        <span id="inputStatus" class="status-value warn">Aguardando conexão...</span>
      </div>
    </div>

    <div class="controls">
      <div class="controls-title">Controles</div>

      <div class="control-row">
        <span class="control-label">Acelerar</span>
        <span class="control-key">Gatilho Direito</span>
      </div>

      <div class="control-row">
        <span class="control-label">Frear / Ré</span>
        <span class="control-key">Analógico Direito (para frente / trás)</span>
      </div>

      <div class="control-row">
        <span class="control-label">Direção</span>
        <span class="control-key">Analógico Esquerdo (esq/dir)</span>
      </div>

      <div class="control-row">
        <span class="control-label">Reset</span>
        <span class="control-key">Clique no Analógico Direito</span>
      </div>
    </div>

    <div id="output">Velocidade: 0.00 m/s</div>
  </div>

  <script>
    // RC Car Demo para Figmin XR

    let carro = null;
    let controleConectado = false;

    const carStatusEl = document.getElementById("carStatus");
    const inputStatusEl = document.getElementById("inputStatus");
    const outputEl = document.getElementById("output");

    function setCarStatus(texto, classe) {
      carStatusEl.textContent = texto;
      carStatusEl.className = "status-value " + (classe || "");
    }

    function setInputStatus(texto, classe) {
      inputStatusEl.textContent = texto;
      inputStatusEl.className = "status-value " + (classe || "");
    }

    // Tenta encontrar um objeto chamado "meu_carro"
    function procurarCarroExistente() {
      // A API oficial expõe figmin.findObjectByName(name) [web:1]
      if (typeof figmin.findObjectByName === "function") {
        const obj = figmin.findObjectByName("meu_carro");
        if (obj) {
          carro = obj;
          setCarStatus("Encontrado: \"meu_carro\"", "ok");
          onCarStart(carro);
          return;
        }
      }
      setCarStatus("Não encontrado (renomeie o 3D para \"meu_carro\")", "err");
    }

    function init() {
      if (!figmin.isSpatialApp()) {
        figmin.requireSpatialApp();
        return;
      }

      setCarStatus("Procurando \"meu_carro\"...", "warn");
      procurarCarroExistente();

      // Mesmo se não encontrar agora, o update ainda roda.
      // Você pode recarregar a página depois de renomear o objeto.
      figmin.setUpdateFunction(update);
    }

    // Configura física e input no carro encontrado
    function onCarStart(obj) {
      // Física de carro básica
      obj.addComponent(figmin.ComponentType.PHYSICS, {
        mass: 2.0,
        drag: 0.2,
        angularDrag: 0.5,
        gravityStrength: 1.0,
        collisionDetectionMode: figmin.physics.CollisionDetectionMode.CONTINUOUS_DYNAMIC,
        kinematic: true // começa parado
      });

      obj.addComponent(figmin.ComponentType.PHYSICS_MATERIAL, {
        bounciness: 0.0,
        staticFriction: 1.0,
        dynamicFriction: 0.8
      });

      // Ícone de conexão com raio
      figmin.enableInputConnect(
        "RC Car Controls",
        [
          figmin.InputCode.SELECT_RIGHT,  // aceleração
          figmin.InputCode.AXIS_Y_RIGHT,  // freio / ré
          figmin.InputCode.AXIS_X_LEFT,   // direção
          figmin.InputCode.THUMB_RIGHT    // reset
        ],
        onInputConnectionChanged,
        obj
      );

      setCarStatus("Pronto: física aplicada em \"meu_carro\"", "ok");
    }

    function onInputConnectionChanged(connected, playerId) {
      controleConectado = connected;
      if (connected) {
        setInputStatus("Conectado (player " + playerId + ")", "ok");
        if (carro && carro.physics) {
          carro.physics.kinematic = false;
        }
      } else {
        setInputStatus("Desconectado", "warn");
      }
    }

    function update(dt) {
      if (!carro || carro.status.state !== figmin.ObjectState.READY || !carro.physics) {
        return;
      }

      // Inputs
      const accelIn = figmin.getInput(figmin.InputCode.SELECT_RIGHT);   // gatilho acelera
      const brakeIn = figmin.getInput(figmin.InputCode.AXIS_Y_RIGHT);   // para frente freia, para trás ré
      const steerIn = figmin.getInput(figmin.InputCode.AXIS_X_LEFT);    // esquerda/direita
      const resetDown = figmin.getInput(figmin.InputCode.THUMB_RIGHT);

      // Reset: coloca na frente da câmera, nive
