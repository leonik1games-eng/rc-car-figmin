<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RC Car Demo - meu_carro</title>
  <meta name="figmin" />

  <style>
    :root {
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --bg: #020617;
      --text-muted: #9ca3af;
      --ui-scale: 1.6;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    .card {
      padding: 24px 28px;
      border-radius: 20px;
      background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      max-width: 440px;
      width: min(90vw, 440px);
      transform: scale(var(--ui-scale));
      transform-origin: center center;
    }

    h1 {
      margin: 0 0 8px;
      font-size: 26px;
      letter-spacing: 0.04em;
    }

    .subtitle {
      margin: 0 0 16px;
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.35;
    }

    #status {
      margin-bottom: 12px;
      font-size: 15px;
      font-weight: 600;
    }

    .ok {
      color: #4ade80;
    }

    .err {
      color: #f97373;
    }

    .warn {
      color: #facc15;
    }

    .controls {
      padding: 14px 16px;
      border-radius: 14px;
      background: var(--accent-soft);
      text-align: left;
      font-size: 14px;
      line-height: 1.5;
    }

    .controls-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-size: 11px;
      margin-bottom: 6px;
      color: #bfdbfe;
    }

    .control-row {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      padding: 2px 0;
    }

    .control-label {
      color: #e5e7eb;
    }

    .control-key {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.6);
      color: #dbeafe;
      white-space: nowrap;
      background: rgba(15, 23, 42, 0.8);
    }

    #output {
      font-size: 13px;
      color: #e5e7eb;
      background: rgba(2, 6, 23, 0.38);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 14px;
      padding: 10px 12px;
      margin: 10px 0 0;
      text-align: left;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>RC Car</h1>
    <p class="subtitle">
      Importe o modelo 3D, renomeie para <b>meu_carro</b> e abra este app no Figmin.<br />
      Use o raio (ícone de raio) para conectar o controle.
    </p>

    <div id="status" class="warn">Aguardando Figmin...</div>

    <div class="controls">
      <div class="controls-title">Controles</div>

      <div class="control-row">
        <span class="control-label">Acelerar</span>
        <span class="control-key">Gatilho Direito</span>
      </div>

      <div class="control-row">
        <span class="control-label">Frear / Ré</span>
        <span class="control-key">Analógico Direito (frente/trás)</span>
      </div>

      <div class="control-row">
        <span class="control-label">Direção</span>
        <span class="control-key">Analógico Esquerdo (esq/dir)</span>
      </div>

      <div class="control-row">
        <span class="control-label">Reset</span>
        <span class="control-key">Clique Analógico Direito</span>
      </div>
    </div>

    <div id="output">Velocidade: 0.00 m/s</div>
  </div>

  <script>
    var car = null;
    var statusDiv = document.getElementById("status");
    var outputEl = document.getElementById("output");

    function setStatus(msg, cls) {
      statusDiv.innerText = msg;
      statusDiv.className = cls || "";
    }

    // FUNÇÕES DE QUATERNION DEFINIDAS NO TOPO (fora do update)
    function qMul(a, b) {
      return {
        w: a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z,
        x: a.w * b.x + a.x * b.w + a.y * b.z - a.z * b.y,
        y: a.w * b.y - a.x * b.z + a.y * b.w + a.z * b.x,
        z: a.w * b.z + a.x * b.y - a.y * b.x + a.z * b.w
      };
    }

    function rotateVectorToLocal(q, v) {
      var qConj = { w: q.w, x: -q.x, y: -q.y, z: -q.z };
      var qv = { w: 0, x: v.x, y: v.y, z: v.z };
      var t1 = qMul(qConj, qv);
      var t2 = qMul(t1, q);
      return { x: t2.x, y: t2.y, z: t2.z };
    }

    document.addEventListener("FigminReady", function () {
      if (!figmin.isSpatialApp()) {
        figmin.requireSpatialApp();
        return;
      }

      setStatus("Procurando objeto \"meu_carro\"...", "warn");

      car = figmin.findObjectByName("meu_carro"); // [web:1]

      if (car) {
        setStatus("PRONTO! ⚡ \"meu_carro\" encontrado", "ok");
        setupCar();
      } else {
        setStatus("ERRO: Cadê \"meu_carro\"?", "err");
      }
    });

    function setupCar() {
      car.addComponent(figmin.ComponentType.PHYSICS, {
        mass: 2.0,
        drag: 0.2,
        angularDrag: 0.5,
        gravityStrength: 1.0,
        collisionDetectionMode: figmin.physics.CollisionDetectionMode.CONTINUOUS_DYNAMIC,
        kinematic: true
      });

      car.addComponent(figmin.ComponentType.PHYSICS_MATERIAL, {
        bounciness: 0.0,
        staticFriction: 1.0,
        dynamicFriction: 0.8
      });

      figmin.enableInputConnect(
        "RC Car Controls",
        [
          figmin.InputCode.SELECT_RIGHT,
          figmin.InputCode.AXIS_Y_RIGHT,
          figmin.InputCode.AXIS_X_LEFT,
          figmin.InputCode.THUMB_RIGHT
        ],
        onInputConnectionChanged,
        car
      ); // [web:1]

      figmin.setUpdateFunction(update);
    }

    function onInputConnectionChanged(connected, playerId) {
      if (connected) {
        setStatus("PRONTO! ⚡ Controle conectado (player " + playerId + ")", "ok");
        if (car && car.physics) {
          car.physics.kinematic = false;
        }
      } else {
        setStatus("Objeto \"meu_carro\" ok, mas controle desconectado", "warn");
      }
    }

    function update(dt) {
      if (!car || car.status.state !== figmin.ObjectState.READY || !car.physics) {
        return;
      }

      var accelIn = figmin.getInput(figmin.InputCode.SELECT_RIGHT);
      var brakeIn = figmin.getInput(figmin.InputCode.AXIS_Y_RIGHT);
      var steerIn = figmin.getInput(figmin.InputCode.AXIS_X_LEFT);
      var resetDown = figmin.getInput(figmin.InputCode.THUMB_RIGHT);

      // Reset
      if (resetDown) {
        var camera = figmin.getCamera();
        var fwd = camera.transform.forward;
        var camPos = camera.transform.position;

        car.transform.position = {
          x: camPos.x + fwd.x * 1.5,
          y: camPos.y,
          z: camPos.z + fwd.z * 1.5
        };

        var camYaw = Math.atan2(fwd.x, fwd.z) * 180 / Math.PI;
        car.transform.rotation = { x: 0, y: camYaw, z: 0 };

        car.physics.velocity = { x: 0, y: 0, z: 0 };
        car.physics.angularVelocity = { x: 0, y: 0, z: 0 };
        return;
      }

      // HUD velocidade
      var v = car.physics.velocity;
      var speed = Math.sqrt(v.x * v.x + v.y * v.y + v.z * v.z);
      outputEl.textContent = "Velocidade: " + speed.toFixed(2) + " m/s";

      if (
        Math.abs(accelIn) < 0.01 &&
        Math.abs(brakeIn) < 0.01 &&
        Math.abs(steerIn) < 0.01
      ) {
        return;
      }

      // Força usando transform.forward convertido para local
      var forwardWorld = car.transform.forward; // [web:1]

      var maxForwardForce = 40.0;
      var forwardForceScalar = accelIn * maxForwardForce;

      var maxBrakeForce = 60.0;
      if (brakeIn > 0.1) {
        forwardForceScalar -= brakeIn * maxBrakeForce;
      } else if (brakeIn < -0.1) {
        forwardForceScalar += -brakeIn * (maxForwardForce * 0.5);
      }

      var forceWorld = {
        x: forwardWorld.x * forwardForceScalar * dt,
        y: forwardWorld.y * forwardForceScalar * dt,
        z: forwardWorld.z * forwardForceScalar * dt
      };

      var forceLocal = rotateVectorToLocal(car.transform.rotationq, forceWorld);

      car.physics.applyForce(forceLocal);

      // Steering
      var maxSteerTorque = 12.0;
      car.physics.applyTorque({
        x: 0,
        y: steerIn * maxSteerTorque * dt,
        z: 0
      });
    }
  </script>
</body>

</html>
