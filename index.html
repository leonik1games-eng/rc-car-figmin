<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RC Car Demo - FUNCIONA</title>
  <meta name="figmin" />
  <style>
    /* Mesmo CSS do anterior, sem mudan√ßas */
    :root {
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --bg: #020617;
      --text-muted: #9ca3af;
      --ui-scale: 1.6;
    }

    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; }
    body {
      font-family: system-ui, sans-serif;
      background: radial-gradient(circle at top, #0f172a 0, #020617 45%, #000 100%);
      color: #f9fafb;
      display: flex; align-items: center; justify-content: center; text-align: center;
    }

    .card {
      padding: 24px 28px; border-radius: 20px; background: rgba(15, 23, 42, 0.95);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.9); border: 1px solid rgba(148, 163, 184, 0.35);
      max-width: 440px; width: min(90vw, 440px); transform: scale(var(--ui-scale)); transform-origin: center center;
    }

    h1 { margin: 0 0 8px; font-size: 26px; letter-spacing: 0.04em; }
    .subtitle { margin: 0 0 16px; font-size: 14px; color: var(--text-muted); line-height: 1.35; }

    #status { margin-bottom: 12px; font-size: 15px; font-weight: 600; }
    .ok { color: #4ade80; }
    .err { color: #f97373; }
    .warn { color: #facc15; }

    .controls { padding: 14px 16px; border-radius: 14px; background: var(--accent-soft); text-align: left; font-size: 14px; line-height: 1.5; }
    .controls-title { text-transform: uppercase; letter-spacing: 0.12em; font-size: 11px; margin-bottom: 6px; color: #bfdbfe; }
    .control-row { display: flex; justify-content: space-between; gap: 16px; padding: 2px 0; }
    .control-label { color: #e5e7eb; }
    .control-key {
      font-family: ui-monospace, Consolas, monospace; font-size: 12px; padding: 3px 8px; border-radius: 999px;
      border: 1px solid rgba(191, 219, 254, 0.6); color: #dbeafe; white-space: nowrap; background: rgba(15, 23, 42, 0.8);
    }

    #output {
      font-size: 13px; color: #e5e7eb; background: rgba(2, 6, 23, 0.38);
      border: 1px solid rgba(148, 163, 184, 0.22); border-radius: 14px; padding: 10px 12px;
      margin: 10px 0 0; text-align: left;
    }
  </style>
</head>

<body>
  <div class="card">
    <h1>RC Car ‚úÖ</h1>
    <p class="subtitle">Renomeie o 3D para <b>meu_carro</b> ‚Üí raio ‚Üí conectar ‚Üí acelera!</p>

    <div id="status" class="warn">Aguardando Figmin...</div>

    <div class="controls">
      <div class="controls-title">Controles</div>
      <div class="control-row"><span class="control-label">Acelerar</span><span class="control-key">Gatilho Direito</span></div>
      <div class="control-row"><span class="control-label">Freio/R√©</span><span class="control-key">Anal√≥gico Direito</span></div>
      <div class="control-row"><span class="control-label">Dire√ß√£o</span><span class="control-key">Anal√≥gico Esquerdo</span></div>
      <div class="control-row"><span class="control-label">Reset</span><span class="control-key">Clique Direito</span></div>
    </div>

    <div id="output">Velocidade: 0.00 m/s</div>
  </div>

  <script>
    var car = null;
    var statusDiv = document.getElementById("status");
    var outputEl = document.getElementById("output");

    function setStatus(msg, cls) {
      statusDiv.innerText = msg;
      statusDiv.className = cls || "";
    }

    document.addEventListener("FigminReady", function () {
      if (!figmin.isSpatialApp()) {
        figmin.requireSpatialApp();
        return;
      }

      setStatus("Procurando \"meu_carro\"...", "warn");

      car = figmin.findObjectByName("meu_carro"); // [web:1]

      if (car) {
        setStatus("‚úÖ \"meu_carro\" encontrado!", "ok");
        setupCar();
      } else {
        setStatus("‚ùå Cad√™ \"meu_carro\"?", "err");
      }
    });

    function setupCar() {
      car.addComponent(figmin.ComponentType.PHYSICS, {
        mass: 1.0, // mais leve
        drag: 0.1,
        angularDrag: 0.3,
        gravityStrength: 1.0,
        collisionDetectionMode: figmin.physics.CollisionDetectionMode.CONTINUOUS_DYNAMIC,
        kinematic: true
      });

      car.addComponent(figmin.ComponentType.PHYSICS_MATERIAL, {
        bounciness: 0.0,
        staticFriction: 0.8,
        dynamicFriction: 0.6 // menos atrito
      });

      figmin.enableInputConnect(
        "RC Car",
        [
          figmin.InputCode.SELECT_RIGHT,
          figmin.InputCode.AXIS_Y_RIGHT,
          figmin.InputCode.AXIS_X_LEFT,
          figmin.InputCode.THUMB_RIGHT
        ],
        onInputConnectionChanged,
        car
      ); // [web:1]

      figmin.setUpdateFunction(update);
    }

    function onInputConnectionChanged(connected, playerId) {
      if (connected) {
        setStatus("‚úÖ CONECTADO! Acelera agora üöóüí®", "ok");
        if (car && car.physics) {
          car.physics.kinematic = false;
        }
      } else {
        setStatus("Desconectado", "warn");
      }
    }

    function update(dt) {
      if (!car || car.status.state !== figmin.ObjectState.READY || !car.physics) {
        return;
      }

      var accelIn = figmin.getInput(figmin.InputCode.SELECT_RIGHT);
      var brakeIn = figmin.getInput(figmin.InputCode.AXIS_Y_RIGHT);
      var steerIn = figmin.getInput(figmin.InputCode.AXIS_X_LEFT);
      var resetDown = figmin.getInput(figmin.InputCode.THUMB_RIGHT);

      // Reset
      if (resetDown) {
        var camera = figmin.getCamera();
        var fwd = camera.transform.forward;
        var camPos = camera.transform.position;

        car.transform.position = {
          x: camPos.x + fwd.x * 1.5,
          y: camPos.y + 0.1, // um pouco acima do ch√£o
          z: camPos.z + fwd.z * 1.5
        };

        var camYaw = Math.atan2(fwd.x, fwd.z) * 180 / Math.PI;
        car.transform.rotation = { x: 0, y: camYaw, z: 0 };

        car.physics.velocity = { x: 0, y: 0, z: 0 };
        car.physics.angularVelocity = { x: 0, y: 0, z: 0 };
        return;
      }

      // VELOCIDADE NO HUD
      var v = car.physics.velocity;
      var speed = Math.sqrt(v.x * v.x + v.y * v.y + v.z * v.z);
      outputEl.textContent = "Velocidade: " + speed.toFixed(2) + " m/s | Acel: " + accelIn.toFixed(2);

      if (Math.abs(accelIn) < 0.01 && Math.abs(brakeIn) < 0.01 && Math.abs(steerIn) < 0.01) {
        return;
      }

      // *** F√çSICA SIMPLES: FOR√áA LOCAL DIRETA NO EIXO Z (SEM CONVERS√ÉO) ***
      var thrustForce = accelIn * 30.0; // for√ßa maior
      if (brakeIn > 0.1) {
        thrustForce -= brakeIn * 50.0;
      } else if (brakeIn < -0.1) {
        thrustForce += Math.abs(brakeIn) * 15.0; // r√©
      }

      // APLICA FOR√áA LOCAL DIRETA (Z = frente do carro)
      car.physics.applyForce({ x: 0, y: 0, z: thrustForce * dt });

      // STEERING: torque Y local
      car.physics.applyTorque({ x: 0, y: steerIn * 15.0 * dt, z: 0 });
    }
  </script>
</body>

</html>
