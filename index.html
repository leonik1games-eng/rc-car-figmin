<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="figmin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SS Play RC Debugger</title>
    <style>
        body {
            background-color: #000;
            color: #0f0; /* Verde Hacker */
            font-family: monospace;
            font-size: 16px;
            padding: 20px;
            text-align: left;
        }
        .hud {
            border: 2px solid #0f0;
            padding: 15px;
            margin-top: 10px;
        }
        h2 { margin: 0; color: #fff; }
        .red { color: #ff3333; }
        .yellow { color: #ffff33; }
    </style>
    <script>
        let car = null;
        let spawnPoint = null;
        let debugText = "";

        // Tenta rodar assim que o Figmin estiver pronto
        document.addEventListener("FigminReady", init);

        function init() {
            // Tenta achar o carro
            car = figmin.findObjectByName("meu_carro");
            spawnPoint = figmin.findObjectByName("spawn_point");

            if (!car) {
                log("ERRO: Objeto 'meu_carro' NÃO encontrado!");
            } else {
                log("SUCESSO: Carro conectado!");
            }

            // Inicia o loop visual e físico
            loop();
        }

        function loop() {
            // 1. Captura os controles
            const gamepads = navigator.getGamepads();
            
            // Pega o primeiro controle ativo (pode ser o da esquerda ou direita)
            // No Quest, geralmente gamepads[0] e [1] são as mãos.
            let gp = null;
            for (let i = 0; i < gamepads.length; i++) {
                if (gamepads[i] && gamepads[i].buttons.length > 0) {
                    gp = gamepads[i];
                    break;
                }
            }

            if (gp) {
                // --- MAPEAMENTO QUEST (Geralmente) ---
                // Botão 0 = Gatilho Indicador (Trigger)
                // Botão 1 = Gatilho de Mão (Grip)
                // Botão 4 = A ou X
                // Botão 5 = B ou Y
                // Eixo 2 = Analógico Horizontal
                // Eixo 3 = Analógico Vertical

                // Lê os valores
                let trigger = gp.buttons[0] ? gp.buttons[0].value : 0; // Acelerar
                let grip = gp.buttons[1] ? gp.buttons[1].value : 0;    // Freio/Ré
                let steer = gp.axes[2] || 0;                           // Direção
                let btnA = gp.buttons[4] ? gp.buttons[4].pressed : false; // Reset 1
                let btnB = gp.buttons[5] ? gp.buttons[5].pressed : false; // Reset 2

                // --- ATUALIZA A TELA (HUD) ---
                // Isso vai te mostrar se o controle tá funcionando!
                let statusHtml = `
                    <div class="hud">
                    STATUS DO CONTROLE:<br>
                    Acelerar (Trigger): ${trigger.toFixed(2)}<br>
                    Freio (Grip): ${grip.toFixed(2)}<br>
                    Direção (Analógico): ${steer.toFixed(2)}<br>
                    Botão A (Reset?): ${btnA ? "PRESSIONADO" : "solto"}<br>
                    Botão B (Reset?): ${btnB ? "PRESSIONADO" : "solto"}<br>
                    </div>
                `;
                document.getElementById("debug").innerHTML = statusHtml;

                // --- FÍSICA DO CARRO ---
                if (car) {
                    let throttle = trigger - grip; // Frente - Ré
                    let forward = car.getForwardVector();

                    // Zona morta
                    if (Math.abs(throttle) > 0.05) {
                        // Força (Ajuste o 0.5 se estiver lento/rápido)
                        car.applyImpulse({
                            x: forward.x * throttle * 0.5,
                            y: forward.y * throttle * 0.5,
                            z: forward.z * throttle * 0.5
                        });
                    }

                    // Curva
                    if (Math.abs(steer) > 0.1) {
                        car.setAngularVelocity({ x: 0, y: -steer * 3.0, z: 0 });
                    }

                    // Reset (Se apertar A ou B)
                    if (btnA || btnB) {
                        resetCar();
                    }
                }
            } else {
                document.getElementById("debug").innerHTML = "<div class='yellow'>Aguardando input do controle...<br>(Aperte algum botão pra acordar)</div>";
            }

            requestAnimationFrame(loop);
        }

        function resetCar() {
            if (!car) return;
            
            // Para o carro
            car.setLinearVelocity({ x: 0, y: 0, z: 0 });
            car.setAngularVelocity({ x: 0, y: 0, z: 0 });

            // Move
            if (spawnPoint) {
                let pos = spawnPoint.getPosition();
                let rot = spawnPoint.getRotation();
                pos.y += 0.2;
                car.setPosition(pos);
                car.setRotation(rot);
            } else {
                // Se não tiver spawn point, joga pro alto no centro
                car.setPosition({x:0, y:1, z:0});
            }
        }

        function log(msg) {
            console.log(msg);
            let el = document.getElementById("logs");
            if (el) el.innerHTML += msg + "<br>";
        }
    </script>
</head>
<body>
    <h2>SS PLAY RC - DEBUG</h2>
    <div id="logs" class="red"></div>
    <div id="debug">Carregando telemetria...</div>
</body>
</html>
